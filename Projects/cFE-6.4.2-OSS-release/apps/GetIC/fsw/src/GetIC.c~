/////////////////////////////////////////////////////////////////////////
//
//  README
//
//  Name: GetParams_App.c
//  By: Alec Forsman - Red Canyon Software
//  Created: 5/12/16
//  Updated: 5/12/16
//
//  Description:
//		This is a Core Flight Application intended to model the GetParams commands in the PLEXIL
//	  Waypoint plan. The app simply creates a pipe to receive messages, and when
//		a message is received it will perform the corresponding neccessary functions and send data
//		back so PLEXIL can continue to update the flight. This can be used in the future as the
//		layout for communication between PLEXIL and CFE.
//
//	Updates:
//		5/12/16
//			- Created
//			- Created SB pipe to receive commands from TestUdp_app.c
//		5/13/16
//			- Improved naming conventions
//		5/16/16-5/18/16
//			- Successfully passed udp of different parameter types into plexil.
//		5/19/16
//			- Got app to send udp to plexil by sleeping for 1 second (plexil is too slow).
//		5/27/16
//			- GetParams_SendReturn now passes 'current' flight parameters.
//
//	Issues/ToDo:
//		- Setup to perform neccessary calculations
//		- Send data back to TestUdp_app.c
//		- Use error check instead of sleeping
//		- Can't get return value sent through
//		- Combine Command Pack structure and Command structure. Shouldn't need both.
//		- CFE goes into unknown status when app quits.
//		- clean up
//		- Implement error checks
//		- NOTE: If app doesn't run, 90% of the time its an issue with the code(will still happen if it compiles)
//
/////////////////////////////////////////////////////////////////////////


#include "GetIC_App.h"
#include "GetIC_Events.h"
#include "GetIC_Msgids.h"

GetIC_AppData_t	GetIC_AppData;

static CFE_EVS_BinFilter_t GetIC_EventFilters[] = 
	{
		{DEBUG,										0x0000},
	};		
		

// Main Function
void GetIC_AppMain(void)
{
	uint32 Status;

	CFE_ES_RegisterApp(); // Register app w/ CFE
	GetIC_init(); // initialize the app. Sets up needed params (Success returns CFE_SUCCESS)
	
	// GetIC Run Loop
	while(CFE_ES_RunLoop(&GetIC_AppData.RunStatus) == TRUE)
	{
	
		Status = CFE_SB_RcvMsg(&GetIC_AppData.MsgPtr, GetIC_AppData.GetICPipe, CFE_SB_PEND_FOREVER);

		if (Status == CFE_SUCCESS);
		{
			CFE_EVS_SendEvent(DEBUG,CFE_EVS_INFORMATION,"GETIC MESSAGE RECEIVED!!!"); //debug
			
			if(CFE_SB_GetMsgId(GetIC_AppData.MsgPtr) == GETIC_MID)
			{
				//GetIC_AppData.DataPacket = (GetIC_DataPacket_t *)CFE_SB_GetUserData(GetIC_AppData.MsgPtr);
				//length = CFE_SB_GetUserDataLength(GetIC_AppData.MsgPtr);
				//full_length = CFE_SB_GetTotalMsgLength(GetIC_AppData.MsgPtr);
				//printf("Data Length: %d, Message Length: %d \n", length, full_length); //debug 
				CFE_EVS_SendEvent(DEBUG,CFE_EVS_INFORMATION,"Message ID matches."); //debug
				
			}

			Get_InitCond();
			//printf("Data Received: %f %f %f %f %f %f %f %f %f %f \n", GetIC_AppData.DataPacket->xWaypoint_A, GetIC_AppData.DataPacket->yWaypoint_A, GetIC_AppData.DataPacket->zWaypoint_A, GetIC_AppData.DataPacket->xWaypoint_B, GetIC_AppData.DataPacket->yWaypoint_B, GetIC_AppData.DataPacket->zWaypoint_B,GetIC_AppData.DataPacket->vel, GetIC_AppData.DataPacket->xLoc, GetIC_AppData.DataPacket->yLoc, GetIC_AppData.DataPacket->zLoc);
			//printf("Data Received: %d %d %d %d %d %d %d %d %d %d \n", GetIC_AppData.DataPacket.xWaypoint_A, GetIC_AppData.DataPacket.yWaypoint_A, GetIC_AppData.DataPacket.zWaypoint_A, GetIC_AppData.DataPacket.xWaypoint_B, GetIC_AppData.DataPacket.yWaypoint_B, GetIC_AppData.DataPacket.zWaypoint_B,GetIC_AppData.DataPacket.vel, GetIC_AppData.DataPacket.xLoc, GetIC_AppData.DataPacket.yLoc, GetIC_AppData.DataPacket.zLoc);
			
			//GetIC_SendReturn(*GetIC_AppData.DataPacket);
			//CFE_ES_ExitApp(GetIC_AppData.RunStatus);
		}
		
	} // End while
	
} // End GetIC_AppMain


//////////////////////////////////////////////////////////////////////////////////////////////////////

void GetIC_init(void)
{
	int status;
	
	CFE_EVS_Register(GetIC_EventFilters, sizeof(GetIC_EventFilters)/sizeof(CFE_EVS_BinFilter_t), CFE_EVS_BINARY_FILTER); // Register Event filter table so events can be output
	
	GetIC_AppData.RunStatus = CFE_ES_APP_RUN;
	
	GetIC_AppData.PipeDepth = GETIC_PIPE_DEPTH;
	strcpy(GetIC_AppData.PipeName, "GETIC_PIPE");	
	
	// Create Receive (command) pipe
	status = CFE_SB_CreatePipe(&GetIC_AppData.GetICPipe, GetIC_AppData.PipeDepth, GetIC_AppData.PipeName);
	if(status != CFE_SUCCESS)
	{
		CFE_EVS_SendEvent(DEBUG,CFE_EVS_ERROR,"Failed to create GetIC pipe");
	}
	
	// Subscribe
	status = CFE_SB_Subscribe(GETIC_MID, GetIC_AppData.GetICPipe);
	if(status != CFE_SUCCESS)
	{
		CFE_EVS_SendEvent(DEBUG,CFE_EVS_ERROR,"Failed to subscribe to GetIC pipe");
	}
	
	//CFE_SB_InitMsg(&TestUdp_AppData.GetICPacket, TESTAPP_GETIC_MID, sizeof(TestUdp_GETICPacket_t), TRUE);
	
	
	CFE_EVS_SendEvent(DEBUG, CFE_EVS_INFORMATION,"GetIC App Initialized");
	
	
} // End GetIC_init


//////////////////////////////////////////////////////////////////////////////////////////////////////

void Get_InitCond(void)
{
	char param[20][20];
	float temp_data[20], data[20];
	int i = 0;
	int status;
	//WP_InitTable_t *InitTblPtr;
	
	CFE_EVS_SendEvent(DEBUG,CFE_EVS_INFORMATION,"Getting Initial Conditions");
	
	//status = CFE_TBL_GetAddress((void **)&InitTblPtr, InitTable_Handle);
	//CFE_EVS_SendEvent(DEBUG,CFE_EVS_INFORMATION,"Getting Initial Conditions");
	//if(status == CFE_TBL_INFO_UPDATED)
	//{
	//	WP_InitTableInit(InitTblPtr);
	//}
	
	FILE *fp;
	fp = fopen("data.txt","rt");
	
	while(fscanf(fp, "%s %f", param[i], &temp_data[i]) != EOF)
	{
		data[i] = temp_data[i];
		i++;
	}
	
	
	// should compare read in parameter and use that to set values
	//printf("%d \n", InitTblPtr->vel);
	//Waypoint_AppData.DataPacket->vel = InitTblPtr->vel;
	//Waypoint_AppData.DataPacket->xLoc = InitTblPtr->xLoc;
	//Waypoint_AppData.DataPacket->yLoc = InitTblPtr->yLoc;
	//Waypoint_AppData.DataPacket->zLoc = InitTblPtr->zLoc;
	//Waypoint_AppData.DataPacket->xWaypoint_A = InitTblPtr->xWaypoint_A;
	//Waypoint_AppData.DataPacket->yWaypoint_A = InitTblPtr->yWaypoint_A;
	//Waypoint_AppData.DataPacket->zWaypoint_A = InitTblPtr->zWaypoint_A;
	//Waypoint_AppData.DataPacket->xWaypoint_B = InitTblPtr->xWaypoint_B;
	//Waypoint_AppData.DataPacket->yWaypoint_B = InitTblPtr->yWaypoint_B;
	//Waypoint_AppData.DataPacket->zWaypoint_B = InitTblPtr->zWaypoint_B;
	
	CFE_EVS_SendEvent(DEBUG,CFE_EVS_INFORMATION,"Message ID matches."); //debug
	//printf("Parameters Received: %d %d %d %d %d %d %d \n", Waypoint_AppData.DataPacket->xWaypoint_A, Waypoint_AppData.DataPacket->yWaypoint_A, Waypoint_AppData.DataPacket->zWaypoint_A, Waypoint_AppData.DataPacket->vel, Waypoint_AppData.DataPacket->xLoc, Waypoint_AppData.DataPacket->yLoc, Waypoint_AppData.DataPacket->zLoc);
	
	
	// DEBUG
	for(i=0;i<10;i++)
	{
		printf("%s \n", param[i]);
		printf("%lf \n", data[i]);
	}

	
	status = CFE_TBL_ReleaseAddress(Waypoint_AppData.TblHandles[0]);
	if(status == CFE_SUCCESS)
	{
		CFE_EVS_SendEvent(DEBUG, CFE_EVS_INFORMATION,"Table address released"); //debug
	}
	else
	{
		CFE_EVS_SendEvent(DEBUG, CFE_EVS_INFORMATION,"Error releasing table address"); //debug
	}
	
	fclose(fp);
	
}







